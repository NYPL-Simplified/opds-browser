<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Webpub Reader</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="cover.jpg" type="image/jpeg">
    <link rel="stylesheet" href="../viewer/main.css">
    <script src="../viewer/require.js"></script>
    <script src="../viewer/webpub-viewer.js"></script>
  </head>
  <body>
  <div id="viewer">
  </div>
  <script>
    var getURLQueryParams = function() {
      var params = {};
      var query = window.location.search;
      if (query && query.length) {
        query = query.substring(1);
        var keyParams = query.split('&');
        for (var x = 0; x < keyParams.length; x++) {
          var keyVal = keyParams[x].split('=');
          if (keyVal.length > 1) {
            params[keyVal[0]] = decodeURIComponent(keyVal[1]);
          }
        }
      }
      return params;
    };

    require(["LocalStorageStore", "IFrameNavigator", "PublisherFont", "SerifFont", "SansFont", "DayTheme", "SepiaTheme", "NightTheme", "ColumnsPaginatedBookView", "ScrollingBookView", "LocalAnnotator", "BookSettings"],
            function (LocalStorageStore, IFrameNavigator, PublisherFont, SerifFont, SansFont, DayTheme, SepiaTheme, NightTheme, ColumnsPaginatedBookView, ScrollingBookView, LocalAnnotator, BookSettings) {
      var element = document.getElementById("viewer");
      var urlParams = getURLQueryParams();
      var webpubManifestUrl = new URL(urlParams['url']);
      var store = new LocalStorageStore.default({ prefix: webpubManifestUrl.href });
      var publisher = new PublisherFont.default();
      var serif = new SerifFont.default();
      var sans = new SansFont.default();
      var day = new DayTheme.default();
      var sepia = new SepiaTheme.default();
      var night = new NightTheme.default();
      var paginator = new ColumnsPaginatedBookView.default();
      var scroller = new ScrollingBookView.default();
      var annotator = new LocalAnnotator.default({ store: store });
      var settingsStore = new LocalStorageStore.default({ prefix: "opds-web-client" });
      var fontSizes = [ 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32 ];
      var defaultFontSize = 20;
      var upLink = {url: new URL("https://github.com/nypl-simplified/opds-web-client"), label: "NYPL", ariaLabel: "Go back to the Github repository"};
      BookSettings.default.create({
        store: settingsStore,
        bookViews: [paginator, scroller],
        fontSizesInPixels: fontSizes,
        defaultFontSizeInPixels: defaultFontSize,
        bookFonts: [publisher, serif, sans],
        bookThemes: [day, sepia, night]
      }).then(function (settings) {
        IFrameNavigator.default.create({
          element: element,
          manifestUrl: webpubManifestUrl,
          store: store,
          settings: settings,
          annotator: annotator,
          paginator: paginator,
          scroller: scroller,
          publisher: publisher,
          serif: serif,
          sans: sans,
          day: day,
          sepia: sepia,
          night: night,
          upLink: upLink,
          allowFullscreen: true
        });
      });
    });
  </script>
  </body>
</html>
